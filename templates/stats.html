{% extends "base.html" %}
{% block content %}
<div class="container mt-4 mb-5">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <h2 class="mb-6">ğŸ“š å›¾ä¹¦ç®¡ç†ç³»ç»Ÿç»Ÿè®¡åˆ†æ</h2>

    <!-- 1. å…¨å±€æ¦‚è§ˆ -->
    <div class="card mb-6 shadow-sm hover-shadow transition-all duration-300">
        <div class="card-header bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
            <h4 class="mb-0 d-flex align-items-center">
                <i class="bi bi-bar-chart-line me-2"></i>å…¨å±€æ¦‚è§ˆ
            </h4>
        </div>
        <div class="card-body">
            <div class="row g-4">
                {% set overall = stats.overall[0] %}
                <div class="col-md-3">
                    <div class="stat-card p-4 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="stat-title text-gray-500 mb-1">å›¾ä¹¦ç§ç±»æ•°</div>
                        <div class="stat-value h3 mb-0">{{ overall.total_titles }}</div>
                        <div class="stat-icon text-blue-500 mt-2"><i class="bi bi-book"></i></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card p-4 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="stat-title text-gray-500 mb-1">å¹³å‡ä»·æ ¼ï¼ˆå…ƒï¼‰</div>
                        <div class="stat-value h3 mb-0">{{ "%.2f"|format(overall.avg_price) if overall.avg_price else 'â€”' }}</div>
                        <div class="stat-icon text-green-500 mt-2"><i class="bi bi-cash"></i></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card p-4 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="stat-title text-gray-500 mb-1">é¦†è—æ€»ä»·å€¼ï¼ˆå…ƒï¼‰</div>
                        <div class="stat-value h3 mb-0">{{ "%.2f"|format(overall.total_value) if overall.total_value else 'â€”' }}</div>
                        <div class="stat-icon text-purple-500 mt-2"><i class="bi bi-piggy-bank"></i></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card p-4 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="stat-title text-gray-500 mb-1">æ€»å‰¯æœ¬æ•°</div>
                        <div class="stat-value h3 mb-0">{{ overall.total_copies }}</div>
                        <div class="stat-icon text-amber-500 mt-2"><i class="bi bi-files"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. åˆ†ç»„ç»Ÿè®¡ï¼ˆå¸¦æ¸…æ™°å›¾è¡¨åï¼‰ -->
    {% for group_name, group_data in stats.items() %}
        {% if group_name != 'overall' and group_data %}
            <!-- å…ˆå®šä¹‰åˆ†ç»„åç§°çš„ä¸­æ–‡æ˜¾ç¤º -->
            {% set group_cn = {
                'location': 'æŒ‰åŒºåŸŸåˆ†å¸ƒ',
                'author': 'æŒ‰ä½œè€…åˆ†å¸ƒ',
                'year': 'æŒ‰å‡ºç‰ˆå¹´ä»½åˆ†å¸ƒ',
                'status': 'æŒ‰å€Ÿé˜…çŠ¶æ€åˆ†å¸ƒ',
                'fine': 'æŒ‰å®Œå¥½çŠ¶æ€åˆ†å¸ƒ',
                'borrower': 'æŒ‰å€Ÿé˜…äººåˆ†å¸ƒ',
                'buy_date': 'æŒ‰é‡‡è´­æ—¥æœŸåˆ†å¸ƒ'
            }[group_name] %}
            <div class="card mb-6 shadow-sm hover-shadow transition-all duration-300">
                <div class="card-header bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                    <h4 class="mb-0 d-flex align-items-center">
                        <!-- åŸå§‹å›¾æ ‡ + åˆ†ç»„å -->
                        {% if group_name == 'location' %}
                            <i class="bi bi-geo-alt me-2"></i>
                        {% elif group_name == 'author' %}
                            <i class="bi bi-pen me-2"></i>
                        {% elif group_name == 'year' %}
                            <i class="bi bi-calendar me-2"></i>
                        {% elif group_name == 'status' %}
                            <i class="bi bi-check-circle me-2"></i>
                        {% elif group_name == 'fine' %}
                            <i class="bi bi-shield me-2"></i>
                        {% elif group_name == 'borrower' %}
                            <i class="bi bi-people me-2"></i>
                        {% elif group_name == 'buy_date' %}
                            <i class="bi bi-cart me-2"></i>
                        {% else %}
                            <i class="bi bi-tag me-2"></i>
                        {% endif %}
                        <!-- åŠ¨æ€æ ‡é¢˜ï¼šåˆ†ç»„å + å½“å‰æŒ‡æ ‡ï¼ˆåˆå§‹ä¸ºâ€œå‰¯æœ¬æ•°â€ï¼‰ -->
                        <span id="card-title-{{ group_name }}">{{ group_cn }} - å‰¯æœ¬æ•°</span>
                    </h4>
                </div>
                <div class="card-body p-5">
                    <!-- æŒ‡æ ‡åˆ‡æ¢æŒ‰é’®ç»„ -->
                    <div class="btn-group mb-4" role="group" aria-label="æŒ‡æ ‡åˆ‡æ¢">
                        <button type="button" class="btn btn-primary active" data-group="{{ group_name }}" data-indicator="total_copies" data-group-cn="{{ group_cn }}">
                            å‰¯æœ¬æ•°
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-group="{{ group_name }}" data-indicator="avg_price" data-group-cn="{{ group_cn }}">
                            å¹³å‡ä»·æ ¼
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-group="{{ group_name }}" data-indicator="total_value" data-group-cn="{{ group_cn }}">
                            æ€»ä»·å€¼
                        </button>
                    </div>
                    <!-- å›¾è¡¨å®¹å™¨ï¼šå†…éƒ¨å°†æ·»åŠ å›¾è¡¨æ ‡é¢˜ -->
                    <div id="chart-{{ group_name }}" class="chart-container" style="width: 100%; height: 450px;"></div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
</div>

<!-- å¼•å…¥ä¾èµ– -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stats = {{ stats|tojson }};
    const chartTypeMap = {
        location: 'pie',
        author: 'pie',
        year: 'bar',
        status: 'pie',
        fine: 'pie',
        borrower: 'pie',
        buy_date: 'bar'
    };
    const indicatorConfig = {
        total_copies: { name: 'å‰¯æœ¬æ•°', unit: 'æœ¬', format: (v) => v || 0 },
        avg_price: { name: 'å¹³å‡ä»·æ ¼', unit: 'å…ƒ', format: (v) => v ? parseFloat(v).toFixed(2) : 0 },
        total_value: { name: 'æ€»ä»·å€¼', unit: 'å…ƒ', format: (v) => v ? parseFloat(v).toFixed(2) : 0 }
    };
    const colorThemes = {
        pie: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#6366f1', '#14b8a6', '#ec4899'],
        bar: [{ type: 'linear', x:0,y:0,x2:0,y2:1, colorStops: [{offset:0,color:'#3b82f6'},{offset:1,color:'#60a5fa'}]}]
    };

    // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
    const charts = {};
    for (const groupName in stats) {
        if (groupName === 'overall' || !stats[groupName].length) continue;
        const chartDom = document.getElementById(`chart-${groupName}`);
        charts[groupName] = echarts.init(chartDom);
        // åˆå§‹æ¸²æŸ“ï¼ˆé»˜è®¤å‰¯æœ¬æ•°ï¼‰
        renderChart(groupName, 'total_copies');
    }

    // æŒ‡æ ‡åˆ‡æ¢äº‹ä»¶ï¼šåŒæ­¥æ›´æ–°ã€å¡ç‰‡æ ‡é¢˜ã€‘å’Œã€å›¾è¡¨ã€‘
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupName = this.dataset.group;
            const indicator = this.dataset.indicator;
            const groupCn = this.dataset.groupCn; // åˆ†ç»„ä¸­æ–‡åç§°ï¼ˆå¦‚â€œæŒ‰åŒºåŸŸåˆ†å¸ƒâ€ï¼‰
            const indicatorCn = indicatorConfig[indicator].name; // æŒ‡æ ‡ä¸­æ–‡åç§°ï¼ˆå¦‚â€œå‰¯æœ¬æ•°â€ï¼‰
            
            // 1. æ›´æ–°æŒ‰é’®æ ·å¼
            this.parentElement.querySelectorAll('button').forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-outline-primary');
            });
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary', 'active');

            // 2. æ›´æ–°å¡ç‰‡æ ‡é¢˜ï¼ˆæ ¸å¿ƒï¼šåˆ†ç»„å + æŒ‡æ ‡åï¼‰
            const cardTitleEl = document.getElementById(`card-title-${groupName}`);
            cardTitleEl.textContent = `${groupCn} - ${indicatorCn}`;

            // 3. é‡ç»˜å›¾è¡¨ï¼ˆåŒæ­¥æ›´æ–°å›¾è¡¨å†…éƒ¨æ ‡é¢˜ï¼‰
            renderChart(groupName, indicator);
        });
    });

    // æ ¸å¿ƒï¼šæ¸²æŸ“å›¾è¡¨ï¼ˆæ–°å¢å›¾è¡¨å†…éƒ¨æ ‡é¢˜ï¼‰
    function renderChart(groupName, indicator) {
        const groupData = stats[groupName];
        const chart = charts[groupName];
        const config = indicatorConfig[indicator];
        const chartType = chartTypeMap[groupName];
        const groupCn = document.querySelector(`button[data-group="${groupName}"]`).dataset.groupCn;
        const chartFullTitle = `${groupCn} - ${config.name}`; // å›¾è¡¨å®Œæ•´æ ‡é¢˜ï¼ˆå¦‚â€œæŒ‰åŒºåŸŸåˆ†å¸ƒ - å‰¯æœ¬æ•°â€ï¼‰

        // å¤„ç†åˆ†ç»„æ ‡ç­¾ï¼ˆå¦‚çŠ¶æ€æ˜ å°„ï¼‰
        const getGroupName = (item) => {
            let name = item.group_key;
            if (groupName === 'status') name = item.group_key === false ? 'æœªå€Ÿå‡º' : 'å·²å€Ÿå‡º';
            else if (groupName === 'fine') name = item.group_key === true ? 'å®Œå¥½' : 'æŸå';
            else if (groupName === 'borrower') name = item.group_key || 'æœªå€Ÿé˜…';
            else if (!name) name = 'æœªåˆ†ç±»';
            return name.length > 12 ? name.substring(0, 12) + '...' : name;
        };

        // å¤„ç†å›¾è¡¨æ•°æ®
        let chartData = [];
        if (chartType === 'pie') {
            chartData = groupData.map(item => ({
                name: getGroupName(item),
                value: config.format(item[indicator])
            }));
        } else if (chartType === 'bar') {
            chartData = {
                xData: groupData.map(item => getGroupName(item)),
                yData: groupData.map(item => config.format(item[indicator]))
            };
        }

        // é€šç”¨é…ç½® + æ–°å¢ã€å›¾è¡¨å†…éƒ¨æ ‡é¢˜ã€‘
        const commonOptions = {
            backgroundColor: 'transparent',
            animation: true,
            animationDuration: 1500,
            // å›¾è¡¨å†…éƒ¨æ ‡é¢˜ï¼ˆä½ç½®ï¼šé¡¶éƒ¨å±…ä¸­ï¼Œå­—ä½“é†’ç›®ï¼‰
            title: {
                text: chartFullTitle,
                left: 'center',
                top: '5%',
                textStyle: {
                    fontSize: 16,
                    fontWeight: 'bold',
                    color: '#333'
                },
                padding: [0, 0, 20, 0] // åº•éƒ¨ç•™ç©ºï¼Œé¿å…é®æŒ¡å›¾è¡¨
            }
        };

        // é¥¼å›¾é…ç½®ï¼ˆå«æ ‡é¢˜ï¼‰
        let chartOption = {};
        if (chartType === 'pie') {
            chartOption = {
                ...commonOptions,
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    formatter: `${config.name}ï¼š<strong>{c}</strong>${config.unit} ({d}%)`
                },
                legend: {
                    orient: groupData.length > 6 ? 'vertical' : 'horizontal',
                    left: groupData.length > 6 ? 'left' : 'center',
                    top: groupData.length > 6 ? 'center' : 'bottom',
                    textStyle: { color: '#666' },
                    formatter: (name) => name.length > 8 ? name.substring(0, 8) + '...' : name
                },
                series: [{
                    name: `${config.name}ï¼ˆ${config.unit}ï¼‰`, // å›¾ä¾‹åç§°å¸¦å•ä½
                    type: 'pie',
                    radius: groupData.length > 10 ? ['30%', '70%'] : ['40%', '70%'],
                    center: ['50%', '55%'], // ä¸‹ç§»ï¼Œç»™é¡¶éƒ¨æ ‡é¢˜ç•™ç©ºé—´
                    color: colorThemes.pie,
                    itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                    label: { show: false },
                    emphasis: { label: { show: true, fontSize: 16, fontWeight: 'bold' } },
                    labelLine: { show: false },
                    data: chartData
                }]
            };
        }

        // æŸ±çŠ¶å›¾é…ç½®ï¼ˆå«æ ‡é¢˜ï¼‰
        else if (chartType === 'bar') {
            chartOption = {
                ...commonOptions,
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    formatter: `${config.name}ï¼š<strong>{c}</strong>${config.unit}`
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '15%', // ä¸Šç§»ï¼Œç»™é¡¶éƒ¨æ ‡é¢˜ç•™ç©ºé—´
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: chartData.xData,
                    axisLabel: { color: '#666', rotate: chartData.xData.length > 8 ? 45 : 0 }
                },
                yAxis: {
                    type: 'value',
                    name: `${config.name}ï¼ˆ${config.unit}ï¼‰`, // yè½´æ ‡é¢˜å¸¦å•ä½
                    nameTextStyle: { color: '#666' },
                    axisLabel: { color: '#666', formatter: (v) => config.format(v) }
                },
                series: [{
                    name: `${config.name}ï¼ˆ${config.unit}ï¼‰`, // å›¾ä¾‹åç§°å¸¦å•ä½
                    type: 'bar',
                    data: chartData.yData,
                    itemStyle: { color: colorThemes.bar[0], borderRadius: [4, 4, 0, 0] }
                }]
            };
        }

        chart.setOption(chartOption);
    }

    // çª—å£ resize é‡ç»˜
    window.addEventListener('resize', () => {
        for (const groupName in charts) charts[groupName].resize();
    });

    // å¡ç‰‡æ‚¬åœæ•ˆæœ
    document.querySelectorAll('.chart-container').forEach(container => {
        const groupName = container.id.replace('chart-', '');
        const chart = charts[groupName];
        container.closest('.card').addEventListener('mouseenter', () => {
            chart.dispatchAction({ type: 'highlight', seriesIndex: 0 });
        });
        container.closest('.card').addEventListener('mouseleave', () => {
            chart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
        });
    });
});
</script>

<style>
/* åŸæœ‰æ ·å¼ + æ ‡é¢˜æ ·å¼ä¼˜åŒ– */
.stat-card { transition: all 0.3s ease; }
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
.hover-shadow:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.transition-all { transition: all 0.3s ease; }
.chart-container { position: relative; }
.btn-group .btn { margin-right: 8px; }
.btn-group .btn:last-child { margin-right: 0; }
/* å›¾è¡¨æ ‡é¢˜æ ·å¼è¡¥å……ï¼ˆé˜²æ­¢ä¸å…¶ä»–å…ƒç´ å†²çªï¼‰ */
.echarts-title { font-size: 16px !important; font-weight: bold !important; }
</style>
{% endblock %}